<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundraising Shop</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        html.dark body { background-color: #111827; color: white; }
        
        .handle { touch-action: none; }
        
        /* Editor Styles */
        .editor-toolbar { display: flex; align-items: center; gap: 4px; }
        .editor-toolbar button, .editor-toolbar label { 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            background: #fff; 
            color: #333; 
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            min-width: 32px;
        }
        .editor-toolbar button:hover, .editor-toolbar label:hover { background: #eee; }
        .editor-content { min-height: 150px; overflow-y: auto; }
        
        /* Color Picker Reset */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            padding: 0;
            overflow: hidden;
            background: transparent;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; }

        #displayBanner { max-height: 200px; width: 100%; object-fit: cover; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-20 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

<script>
    // ‚ö†Ô∏è DEPLOYED WEB APP URL
    const API_URL = "https://script.google.com/macros/s/AKfycbxpgGDFHHhENaWSd50Vm70C5kioPu9nba89QDN4dJ8W-JsHsQfMZNJpIH_YqnlwROmf/exec"; 
    
    function initTheme() {
        try {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        } catch(e) { console.log("Theme init error", e); }
    }
    
    function toggleDarkMode() {
        try {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
        } catch(e) { alert("Error toggling theme"); }
    }
    initTheme();
</script>

<div id="loadingOverlay" class="fixed inset-0 bg-white/90 dark:bg-gray-900/90 z-50 flex flex-col items-center justify-center hidden">
    <div class="loader"></div>
    <p id="loadingText" class="mt-4 font-semibold text-blue-600 animate-pulse">Processing...</p>
</div>

<header class="bg-blue-700 text-white py-2 px-4 shadow-md sticky top-0 z-40 dark:bg-blue-900">
    <div class="flex justify-between items-center max-w-lg mx-auto">
        <h1 class="font-bold text-lg cursor-pointer" onclick="router('home')" id="appTitleDisplay">Fundraising Drive</h1>
        <div class="flex gap-4 items-center">
            <button onclick="toggleDarkMode()" class="text-xl p-1 hover:text-blue-200 transition-transform hover:scale-110" title="Toggle Dark Mode">üåó</button>
            <i class="fas fa-cog cursor-pointer hover:text-blue-200 mt-1" onclick="openAdminAuth()"></i>
            <div class="relative cursor-pointer" onclick="router('cart')">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="headerCartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </div>
        </div>
    </div>
</header>

<main class="max-w-lg mx-auto min-h-screen relative">
    
    <!-- HOME -->
    <section id="view-home" class="p-6 fade-in">
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6 dark:bg-gray-800 dark:shadow-none dark:border dark:border-gray-700">
            <img id="displayBanner" src="" class="hidden w-full object-cover max-h-48">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-blue-700 dark:text-blue-400 mb-4 text-center">Welcome!</h2>
                <div id="displayIntro" class="prose text-gray-600 dark:text-gray-300 mb-6">Loading...</div>
                <div id="shopStatusBanner" class="hidden mb-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 rounded text-center font-bold text-sm">Shop is Closed</div>
                <button id="startShoppingBtn" onclick="router('shop')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg dark:shadow-none">Start Shopping</button>
            </div>
        </div>
        <div class="text-center text-xs text-gray-400">Current Event: <span id="displayEventName">Loading...</span></div>
    </section>

    <!-- SHOP -->
    <section id="view-shop" class="p-4 hidden fade-in">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-store"></i> Items</h2>
            <button onclick="router('home')" class="text-sm text-blue-600 dark:text-blue-400 font-semibold hover:underline"><i class="fas fa-arrow-left"></i> Home</button>
        </div>
        <div id="shopClosedMsg" class="hidden bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded relative mb-4 text-sm text-center font-bold">
            The shop is currently closed. Ordering is unavailable.
        </div>
        <div id="productList" class="grid grid-cols-1 gap-4"></div>
        <div class="mt-6 text-center">
            <button id="shopViewCartBtn" onclick="router('cart')" class="bg-gray-800 text-white px-6 py-3 rounded-full font-bold shadow-lg text-sm w-full max-w-xs transition hover:bg-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600">View Cart & Checkout ($0.00)</button>
        </div>
    </section>

    <!-- CART -->
    <section id="view-cart" class="p-4 hidden fade-in">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Your Cart</h2>
            <button onclick="router('shop')" class="text-sm text-blue-600 dark:text-blue-400 font-semibold hover:underline"><i class="fas fa-plus"></i> Shop More</button>
        </div>
        <div id="cartItems" class="space-y-4 mb-6"></div>
        <div id="cartSummary" class="hidden">
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-t-4 border-blue-600 mb-4">
                <div class="flex justify-between font-bold text-lg"><span>Total:</span><span id="cartTotal">$0.00</span></div>
            </div>
            <button id="checkoutBtn" onclick="router('checkout')" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg mb-3 hover:bg-green-700">Proceed to Checkout</button>
            <button onclick="router('shop')" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 py-3 rounded-lg font-bold">Continue Shopping</button>
        </div>
    </section>

    <!-- CHECKOUT -->
    <section id="view-checkout" class="p-4 hidden fade-in">
        <div class="flex items-center gap-2 mb-4">
             <button onclick="router('cart')" class="text-gray-500 dark:text-gray-400"><i class="fas fa-arrow-left"></i></button>
             <h2 class="text-xl font-bold">Payment & Submit</h2>
        </div>
        
        <!-- COMPACT QR SECTION -->
        <div class="bg-white dark:bg-gray-800 border-2 border-purple-800 dark:border-purple-600 p-3 rounded-lg mb-4 shadow-sm">
            <div class="flex flex-row items-center gap-4">
                <!-- Left: QR and Download -->
                <div class="flex flex-col items-center gap-2 shrink-0">
                    <div class="bg-white p-1 rounded border dark:border-gray-600">
                        <canvas id="qrCanvas" class="w-24 h-24"></canvas>
                    </div>
                    <!-- Download Button Below QR -->
                    <a id="downloadQrBtn" href="#" download="paynow_qr.png" class="w-full text-center bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-1 rounded text-xs font-bold hover:bg-purple-200 dark:hover:bg-purple-800">
                        <i class="fas fa-download"></i> Save QR
                    </a>
                </div>

                <!-- Right: Details -->
                <div class="flex-1 text-left flex flex-col justify-center h-full">
                    <!-- LARGER LOGO -->
                    <div class="mb-2">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrFTTv8ACzZZSrgYoLfi00cQmG-hPk0Pxdzg&s" alt="PayNow" class="h-12 object-contain">
                    </div>
                    
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Pay:</span>
                        <span id="paynowTotalDisplay" class="text-xl font-bold text-purple-700 dark:text-purple-400">$0.00</span>
                    </div>
                    
                    <div class="mb-2">
                        <p class="text-xs text-gray-500 dark:text-gray-400">To: <span id="paynowNumberDisplay" class="font-mono font-bold text-gray-800 dark:text-gray-200">...</span></p>
                    </div>

                    <div class="inline-block">
                        <span class="text-xs text-purple-700 dark:text-purple-300 font-bold bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded border border-purple-200 dark:border-purple-800">Ref: <span id="paynowRefDisplay">---</span></span>
                    </div>
                </div>
            </div>
        </div>

        <form id="checkoutForm" onsubmit="handleSubmission(event)" class="space-y-4 bg-white dark:bg-gray-800 p-5 rounded shadow">
            <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Full Name</label><input type="text" name="customerName" required class="w-full p-2 border rounded mt-1 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">WhatsApp No.</label><input type="tel" name="contact" id="contactInput" required placeholder="e.g. 91234567" class="w-full p-2 border rounded mt-1 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Email</label><input type="email" name="email" required class="w-full p-2 border rounded mt-1 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">I am a...</label>
                <select id="userType" name="userType" onchange="handleUserTypeChange()" required class="w-full p-2 border rounded mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">Select...</option>
                    <option value="Volunteer">Volunteer</option>
                    <option value="Friend/Family">Friend of Volunteer</option>
                    <option value="Caregiver">Caregiver</option>
                    <option value="Public">Public</option>
                </select>
            </div>
            <div id="dynamicField" class="hidden">
                <label id="dynamicLabel" class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Name</label>
                <input type="text" id="relatedName" name="relatedName" class="w-full p-2 border rounded mt-1 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Payment Screenshot</label>
                <input type="file" id="paymentProof" accept="image/*" required class="w-full text-sm text-gray-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mt-4 shadow">Submit Order</button>
        </form>
    </section>

    <!-- SUCCESS -->
    <section id="view-success" class="p-6 hidden fade-in flex flex-col items-center justify-center min-h-[60vh]">
        <div class="bg-green-100 dark:bg-green-900 p-4 rounded-full mb-4"><i class="fas fa-check text-4xl text-green-600 dark:text-green-400"></i></div>
        <h2 class="text-2xl font-bold text-green-700 dark:text-green-400 mb-2">Order Submitted!</h2>
        
        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-3 mb-4 text-center">
            <p class="text-sm text-blue-800 dark:text-blue-200">A confirmation email has been sent to <br><span id="successEmailDisplay" class="font-bold">...</span></p>
        </div>

        <div id="successCollectionDetails" class="hidden w-full bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded p-4 mb-6 text-center">
            <p class="text-xs font-bold text-amber-700 dark:text-amber-300 uppercase mb-1">Collection Details</p>
            <p id="successFooterText" class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow w-full mb-6">
             <div class="flex justify-between items-center mb-4">
                 <span class="text-sm text-gray-500 dark:text-gray-400 font-bold uppercase">Order ID</span>
                 <span id="successOrderId" class="text-xl font-mono font-bold text-gray-800 dark:text-gray-100">ORD-XXXX</span>
             </div>
             
             <div class="border-t border-b border-gray-200 dark:border-gray-700 py-3 mb-3">
                 <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Order Summary</p>
                 <div id="successSummary" class="space-y-1 text-sm text-gray-700 dark:text-gray-300"></div>
             </div>

             <div class="flex justify-between items-center">
                 <span class="text-sm text-gray-500 dark:text-gray-400 font-bold uppercase">Total</span>
                 <span id="successTotal" class="text-xl font-bold text-blue-600 dark:text-blue-400">$0.00</span>
             </div>
        </div>
        
        <button onclick="sendWhatsapp()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 shadow-lg flex items-center justify-center gap-2 mb-3 px-4 text-center text-sm">
            <i class="fab fa-whatsapp text-xl shrink-0"></i> Press Here to send yourself the order confirmation via WhatsApp
        </button>
        <button onclick="router('home')" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Back to Home</button>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="p-4 hidden fade-in bg-gray-100 dark:bg-gray-900 min-h-screen">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Manager Dashboard</h2>
            <button onclick="adminLogout()" class="text-red-500 text-sm font-bold">Log Out</button>
        </div>
        
        <div class="flex border-b border-gray-300 dark:border-gray-700 mb-4">
            <button onclick="switchAdminTab('dashboard')" id="tab-dashboard" class="flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600 dark:text-blue-400 dark:border-blue-400">Dashboard</button>
            <button onclick="switchAdminTab('summary')" id="tab-summary" class="flex-1 py-2 font-bold text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">Summary</button>
            <button onclick="switchAdminTab('fulfillment')" id="tab-fulfillment" class="flex-1 py-2 font-bold text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">Fulfillment</button>
        </div>

        <div id="admin-panel-dashboard">
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-6">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-gray-700 pb-2">üìÖ Canvassing Event</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Current: <span id="adminEventName" class="font-mono text-black dark:text-white">Loading...</span></p>
                
                <div class="mb-4 bg-gray-50 dark:bg-gray-700 p-3 rounded">
                    <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Switch Event</label>
                    <div class="flex gap-2">
                        <select id="eventSelector" class="flex-1 p-2 border rounded text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option>Loading...</option>
                        </select>
                        <button onclick="handleSwitchEvent()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-700">Switch</button>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button onclick="openEventSheet()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold flex items-center justify-center gap-2 shadow hover:bg-green-700 text-sm">
                        <i class="fas fa-table"></i> Open Sheet
                    </button>
                    <button onclick="openEventFolder()" class="flex-1 bg-gray-700 text-white py-2 rounded font-bold flex items-center justify-center gap-2 shadow hover:bg-gray-800 text-sm">
                        <i class="fas fa-folder"></i> Open Folder
                    </button>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="newEventName" placeholder="New Event Name" class="flex-1 p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button onclick="createNewEvent()" class="bg-gray-800 dark:bg-gray-700 text-white px-4 py-2 rounded text-sm font-bold">Create New</button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-6">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-gray-700 pb-2">‚öôÔ∏è App Settings</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">App Title</label>
                        <input type="text" id="editAppTitle" class="w-full p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Banner Image (Optional)</label>
                        <input type="file" id="newBannerImg" accept="image/*" class="w-full text-sm text-gray-500 dark:text-gray-400 mb-1">
                        <button onclick="uploadBanner()" class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">Upload Banner</button>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Introduction (Rich Text)</label>
                        <div class="border rounded dark:border-gray-600">
                            <div class="bg-gray-100 dark:bg-gray-700 p-1 border-b dark:border-gray-600 editor-toolbar flex gap-1 flex-wrap">
                                <button type="button" onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                                <button type="button" onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                                <button type="button" onclick="formatDoc('underline')" title="Underline"><u>U</u></button>
                                
                                <label title="Text Color" class="relative">
                                    <i class="fas fa-palette"></i>
                                    <input type="color" onchange="formatDoc('foreColor', this.value)" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                                </label>

                                <button type="button" onclick="applyHighlight()" title="Highlight (Yellow)">
                                    <i class="fas fa-highlighter text-yellow-600"></i>
                                </button>
                            </div>
                            <div id="editIntroRich" contenteditable="true" class="p-2 min-h-[150px] text-sm dark:text-white bg-white dark:bg-gray-700"></div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Email Intro Message</label>
                        <textarea id="editEmailIntro" rows="5" class="resize-y w-full p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Text before order details..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Email Footer (Collection Details)</label>
                        <textarea id="editEmailFooter" rows="5" class="resize-y w-full p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Text after order details..."></textarea>
                    </div>

                    <div><label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">PayNow Number (8 Digits)</label><input type="tel" id="editPayment" maxlength="8" class="w-full p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g. 91234567"></div>
                    <div>
                        <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Closing Date</label>
                        <div class="flex items-center gap-2">
                             <input type="date" id="editClosingDate" class="p-2 border rounded text-sm flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="updateDatePreview()">
                             <span id="datePreview" class="text-sm font-bold text-blue-600 dark:text-blue-400 whitespace-nowrap"></span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Orders prohibited after this date.</p>
                    </div>
                    <div><label class="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-1 uppercase tracking-wide">Admin PIN</label><input type="text" id="editPin" class="w-full p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                    <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Save Settings</button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-10">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-700 pb-2">üì¶ Manage Products</h3>
                <div class="flex gap-2 mb-4">
                    <button onclick="saveListing()" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded shadow hover:bg-blue-700">üíæ Save Listing</button>
                    <button onclick="resetOrder()" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-xs font-bold py-2 rounded shadow hover:bg-gray-300">üîÑ Reset A-Z</button>
                </div>
                <div id="adminProductList" class="space-y-2 mb-6"></div>
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
                    <!-- NEW: Prominent Add Header -->
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200 dark:border-gray-600">
                         <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                             <i class="fas fa-plus"></i>
                         </div>
                         <span class="font-bold text-blue-800 dark:text-blue-300 text-sm uppercase tracking-wide">Add New Product</span>
                    </div>

                    <input type="text" id="newProdName" placeholder="Product Name" class="w-full p-2 border rounded mb-2 text-sm dark:bg-gray-800 dark:border-gray-500 dark:text-white">
                    <input type="number" id="newProdPrice" placeholder="Price ($)" class="w-full p-2 border rounded mb-2 text-sm dark:bg-gray-800 dark:border-gray-500 dark:text-white">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Product Image</label>
                    <input type="file" id="newProdImg" accept="image/*" class="w-full text-sm text-gray-500 dark:text-gray-400 mb-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-600 dark:file:text-gray-200">
                    <button onclick="addProduct()" class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold">Upload & Add Product</button>
                </div>
            </div>
        </div>

        <div id="admin-panel-summary" class="hidden">
            <div id="summaryContent" class="space-y-6">
                <!-- Summary content unchanged -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 border-blue-500">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Total Revenue</p>
                        <p id="sumRevenue" class="text-2xl font-bold text-gray-800 dark:text-white">Loading...</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 border-green-500">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Total Orders</p>
                        <p id="sumOrders" class="text-2xl font-bold text-gray-800 dark:text-white">Loading...</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 border-purple-500 col-span-2">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Top Selling Item</p>
                        <p id="sumTopItem" class="text-lg font-bold text-gray-800 dark:text-white">Loading...</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-3 border-b dark:border-gray-700 pb-2">üìä Detailed Breakdown</h3>
                    <div class="mb-4">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Group By:</label>
                        <select id="summaryGroupBy" onchange="renderConfigurableSummary()" class="w-full p-2 border rounded mt-1 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="item">Product Item</option>
                            <option value="userType">User Type</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-200">
                                <tr>
                                    <th scope="col" class="px-4 py-3 rounded-l-lg">Group</th>
                                    <th scope="col" class="px-4 py-3">Count</th>
                                    <th scope="col" class="px-4 py-3 rounded-r-lg">Total ($)</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-panel-fulfillment" class="hidden">
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-4">
                 <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-2">Order Search</h3>
                 <div class="flex gap-2">
                     <input type="text" id="orderSearchInput" onkeyup="filterOrders()" placeholder="Search Name, Phone or Order ID..." class="flex-1 p-2 border rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                     <button onclick="loadAdminOrders()" class="bg-blue-600 text-white px-3 py-2 rounded"><i class="fas fa-sync"></i></button>
                 </div>
            </div>
            <div id="orderListContainer" class="space-y-3 pb-10">
                <p class="text-center text-gray-400 py-4">Loading orders...</p>
            </div>
        </div>

    </section>
</main>


<script>
    let appData = { config: {}, products: [], activeEventName: '', activeSheetId: null, activeFolderId: null };
    let cart = []; 
    let lastOrderDetails = null;
    let currentOrderId = null; 
    let ADMIN_PIN = null;
    let allOrders = []; 
    let sortableInstance = null; 

    // Rich Text Helper
    function formatDoc(cmd, value=null) {
        document.execCommand(cmd, false, value);
    }
    
    // Custom Highlight Function for Visibility
    function applyHighlight() {
        const selection = window.getSelection();
        if (selection.rangeCount) {
            const range = selection.getRangeAt(0);
            const span = document.createElement("span");
            // Tailwind class ensuring text is black on yellow bg even in dark mode
            span.className = "bg-yellow-200 text-gray-900 dark:bg-yellow-500 dark:text-black px-1 rounded";
            span.textContent = selection.toString();
            
            // Basic handling: delete selection and insert span
            // Note: This is a simple implementation. Complex selections might need better handling.
            range.deleteContents();
            range.insertNode(span);
        }
    }

    // Initialize App Data
    window.onload = loadAppData;

    async function apiCall(action, payload = {}) {
        showLoading(true);
        try {
            const body = { action, payload, pin: ADMIN_PIN };
            if (action === 'CREATE_EVENT') body.eventName = payload; 
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
            const json = await res.json();
            if (!json.success) throw new Error(json.message);
            return json;
        } catch (e) { alert("Error: " + e.message); throw e; } 
        finally { showLoading(false); }
    }

    async function loadAppData() {
        try {
            const res = await apiCall('GET_APP_DATA');
            appData = res.data;
            updateUI();
        } catch(e) {}
    }

    function updateUI() {
        document.title = appData.config.appTitle || "Fundraising Shop";
        document.getElementById('appTitleDisplay').innerText = appData.config.appTitle || "Fundraising Drive";
        document.getElementById('editAppTitle').value = appData.config.appTitle || "";

        document.getElementById('displayIntro').innerHTML = appData.config.intro || '';
        document.getElementById('editIntroRich').innerHTML = appData.config.intro || '';

        const bannerEl = document.getElementById('displayBanner');
        if (appData.config.bannerImageId) {
            bannerEl.src = "https://lh3.googleusercontent.com/d/" + appData.config.bannerImageId;
            bannerEl.classList.remove('hidden');
        } else {
            bannerEl.classList.add('hidden');
        }

        document.getElementById('editPayment').value = appData.config.paymentInfo || '';
        document.getElementById('displayEventName').innerText = appData.activeEventName || 'None';
        document.getElementById('editClosingDate').value = appData.config.closingDate || '';
        
        document.getElementById('editEmailIntro').value = appData.config.emailIntro || '';
        document.getElementById('editEmailFooter').value = appData.config.emailFooter || '';
        
        updateDatePreview();
        checkShopStatus();
        renderProducts();
        renderCart();
    }
    
    // ... (updateDatePreview, checkShopStatus unchanged) ...
    function updateDatePreview() {
        const val = document.getElementById('editClosingDate').value;
        const el = document.getElementById('datePreview');
        if (!val) { el.innerText = ''; return; }
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const parts = val.split('-');
        if(parts.length < 3) return; 
        const year = parts[0];
        const month = months[parseInt(parts[1], 10) - 1];
        const day = parseInt(parts[2], 10);
        el.innerText = `${day} ${month} ${year}`;
    }
    function checkShopStatus() {
        if (!appData.config.closingDate) return;
        const closeDate = new Date(appData.config.closingDate);
        const today = new Date();
        today.setHours(0,0,0,0);
        const isClosed = today > closeDate;
        if (isClosed) {
            document.getElementById('shopStatusBanner').classList.remove('hidden');
            document.getElementById('startShoppingBtn').disabled = true;
            document.getElementById('startShoppingBtn').innerText = "Shop Closed";
            document.getElementById('startShoppingBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
            document.getElementById('startShoppingBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('shopClosedMsg').classList.remove('hidden');
            document.getElementById('shopViewCartBtn').disabled = true;
            document.getElementById('shopViewCartBtn').classList.add('bg-gray-400');
        } else {
             document.getElementById('shopStatusBanner').classList.add('hidden');
             document.getElementById('shopClosedMsg').classList.add('hidden');
        }
        return isClosed;
    }

    function renderProducts() {
        const isClosed = checkShopStatus();
        const list = document.getElementById('productList');
        if (appData.products.length === 0) { list.innerHTML = `<p class="text-center text-gray-400 py-10">No items available.</p>`; return; }
        list.innerHTML = appData.products.map(p => {
            const inCart = cart.find(c => c.id === p.id);
            const btnHtml = isClosed ? 
                `<span class="text-xs text-red-500 font-bold">Unavailable</span>` :
                (inCart ? `<div class="flex items-center bg-blue-50 dark:bg-gray-700 rounded-lg overflow-hidden border border-blue-100 dark:border-gray-600"><button onclick="deleteItem('${p.id}')" class="w-8 h-8 flex items-center justify-center text-red-500 font-bold hover:bg-red-100 dark:hover:bg-red-900"><i class="fas fa-trash-alt text-xs"></i></button><button onclick="updateQty('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold hover:bg-blue-200 dark:hover:bg-gray-600">-</button><span class="w-8 text-center text-sm font-bold text-blue-800 dark:text-gray-100">${inCart.qty}</span><button onclick="updateQty('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold hover:bg-blue-200 dark:hover:bg-gray-600">+</button></div>` : `<button onclick="addToCart('${p.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm">Add to Cart</button>`);

            return `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow flex overflow-hidden border border-gray-100 dark:border-gray-700 relative">
                <div class="w-24 h-full bg-gray-200 shrink-0 absolute left-0 top-0 bottom-0"><img src="${p.image}" class="w-full h-full object-cover"></div>
                <div class="p-3 flex-1 flex flex-col justify-between pl-28 min-h-[100px]">
                    <div class="flex justify-between items-start"><h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm">${p.name}</h3><span class="text-blue-600 dark:text-blue-400 font-bold">$${p.price}</span></div>
                    <div class="self-end mt-2">
                        ${ btnHtml }
                    </div>
                </div>
            </div>`
        }).join('');
    }

    function renderCart() {
        const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        document.getElementById('cartTotal').innerText = `$${total.toFixed(2)}`;
        document.getElementById('headerCartCount').innerText = cart.reduce((s, i) => s + i.qty, 0);
        const shopBtn = document.getElementById('shopViewCartBtn');
        if (shopBtn) shopBtn.innerText = `View Cart & Checkout ($${total.toFixed(2)})`;
        const container = document.getElementById('cartItems');
        if (cart.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-12 flex flex-col items-center"><i class="fas fa-shopping-basket text-4xl mb-3"></i><p>Your cart is empty</p></div>';
            document.getElementById('cartSummary').classList.add('hidden');
        } else {
            document.getElementById('cartSummary').classList.remove('hidden');
            container.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded shadow-sm border-l-4 border-blue-500">
                    <div><div class="font-bold text-sm text-gray-800 dark:text-gray-100">${item.name}</div><div class="text-xs text-gray-500 dark:text-gray-400">$${item.price} x ${item.qty}</div></div>
                    <div class="flex items-center gap-3">
                        <button onclick="deleteItem('${item.id}')" class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 font-bold hover:bg-red-200"><i class="fas fa-trash-alt text-xs"></i></button>
                        <button onclick="updateQty('${item.id}', -1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 font-bold">-</button>
                        <span class="text-sm font-bold w-4 text-center text-gray-800 dark:text-gray-100">${item.qty}</span>
                        <button onclick="updateQty('${item.id}', 1)" class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 font-bold">+</button>
                    </div>
                </div>`).join('');
        }
    }

    function addToCart(id) { const product = appData.products.find(p => p.id === id); if (product) { cart.push({ ...product, qty: 1 }); refreshAllViews(); } }
    
    function updateQty(id, change) { 
        const index = cart.findIndex(item => item.id === id); 
        if (index > -1) { 
            cart[index].qty += change; 
            if (cart[index].qty <= 0) cart.splice(index, 1); 
            refreshAllViews(); 
        } 
    }
    
    function deleteItem(id) {
        const index = cart.findIndex(item => item.id === id);
        if (index > -1) {
            cart.splice(index, 1);
            refreshAllViews();
        }
    }
    
    function refreshAllViews() { renderProducts(); renderCart(); }

    function handleUserTypeChange() {
        const type = document.getElementById('userType').value;
        const field = document.getElementById('dynamicField');
        const input = document.getElementById('relatedName');
        const label = document.getElementById('dynamicLabel');
        if (type === 'Friend/Family') { field.classList.remove('hidden'); label.innerText = "Name of Volunteer"; input.required = true; }
        else if (type === 'Caregiver') { field.classList.remove('hidden'); label.innerText = "Name of Trainee"; input.required = true; }
        else { field.classList.add('hidden'); input.required = false; }
    }

    function generateOrderId() { return "ORD-" + Math.floor(1000 + Math.random() * 9000); }
    function generatePayNowQR() {
        currentOrderId = generateOrderId();
        const totalAmount = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        const uen = appData.config.paymentInfo; 
        document.getElementById('paynowTotalDisplay').innerText = `$${totalAmount.toFixed(2)}`;
        document.getElementById('paynowNumberDisplay').innerText = uen ? "+65 " + uen : "Not Set";
        document.getElementById('paynowRefDisplay').innerText = currentOrderId;
        if (!uen || totalAmount <= 0) return;
        const payload = createPayNowPayload(uen, totalAmount, currentOrderId);
        new QRious({ element: document.getElementById('qrCanvas'), value: payload, size: 200, level: 'H' });
        const canvas = document.getElementById('qrCanvas');
        document.getElementById('downloadQrBtn').href = canvas.toDataURL("image/png");
    }
    function createPayNowPayload(number, amount, refId) {
        const amtStr = amount.toFixed(2);
        const proxy = `+65${number}`;
        const acctInfoContent = `0009SG.PAYNOW0101002${pad(proxy.length)}${proxy}03010`;
        const acctInfo = `26${pad(acctInfoContent.length)}${acctInfoContent}`;
        const refContent = `01${pad(refId.length)}${refId}`;
        const refField = `62${pad(refContent.length)}${refContent}`;
        let raw = `000201010212` + acctInfo + `52040000` + `5303702` + `54${pad(amtStr.length)}${amtStr}` + `5802SG` + `5911Fundraising` + `6009Singapore` + refField + `6304`;
        return raw + calcCRC(raw);
    }
    function pad(len) { return len < 10 ? `0${len}` : `${len}`; }
    function calcCRC(str) {
        let crc = 0xFFFF;
        for (let i = 0; i < str.length; i++) {
            let c = str.charCodeAt(i);
            crc ^= (c << 8) & 0xFFFF;
            for (let j = 0; j < 8; j++) {
                if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
                else crc = crc << 1;
                crc &= 0xFFFF;
            }
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    async function handleSubmission(e) {
        e.preventDefault();
        if (checkShopStatus()) return alert("Shop is closed.");
        if (cart.length === 0) return alert("Cart empty");
        if (!confirm("Submit Order?")) return;
        
        const form = new FormData(e.target);
        const file = document.getElementById('paymentProof').files[0];
        
        showLoading(true, "Compressing Payment Proof...");
        // Added Timeout logic
        let base64;
        try {
            base64 = await compressImage(file, 0.5);
        } catch (e) {
            showLoading(false);
            alert("Error processing image: " + e.message + "\nPlease try a different file.");
            return;
        }
        
        showLoading(true, "Submitting Order...");
        const totalAmount = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        
        const payload = {
            orderId: currentOrderId,
            customerName: form.get('customerName'),
            contact: form.get('contact'),
            email: form.get('email'),
            userType: form.get('userType'),
            relatedName: form.get('relatedName') || 'N/A',
            cart: cart,
            totalAmount: totalAmount,
            paymentProofBase64: base64,
            mimeType: 'image/jpeg' 
        };

        try {
            const res = await apiCall('SUBMIT_ORDER', payload);
            lastOrderDetails = { id: res.data.orderId, total: totalAmount, customerName: payload.customerName, email: payload.email, contact: payload.contact, cart: [...cart] };
            cart = []; e.target.reset(); refreshAllViews();
            document.getElementById('successOrderId').innerText = lastOrderDetails.id;
            document.getElementById('successTotal').innerText = `$${lastOrderDetails.total.toFixed(2)}`;
            
            // Populate Success Screen Details
            document.getElementById('successEmailDisplay').innerText = lastOrderDetails.email || "your email";
            
            const summaryHtml = lastOrderDetails.cart.map(i => `
                <div class="flex justify-between">
                    <span>${i.name} (x${i.qty})</span>
                    <span class="font-mono">$${(i.price * i.qty).toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('successSummary').innerHTML = summaryHtml;

            // Show collection details if they exist
            const footerText = appData.config.emailFooter;
            if(footerText) {
                document.getElementById('successFooterText').innerText = footerText;
                document.getElementById('successCollectionDetails').classList.remove('hidden');
            } else {
                document.getElementById('successCollectionDetails').classList.add('hidden');
            }

            router('success');

        } catch(err) { console.error(err); }
    }

    function sendWhatsapp() {
        if (!lastOrderDetails) return;
        let num = lastOrderDetails.contact.replace(/\D/g, '');
        if (num.length === 8) num = '65' + num;
        
        const intro = appData.config.emailIntro || `Hi ${lastOrderDetails.customerName}, thank you for your support! We have received your order.`;
        const footer = appData.config.emailFooter || "If you have any questions, please reply to this message.";
        
        const itemsList = lastOrderDetails.cart.map((i, index) => 
            `${index+1}. ${i.name}\n   Qty: ${i.qty} | Sub: $${(i.price * i.qty).toFixed(2)}`
        ).join('\n\n');

        const msg = `*Order Confirmation*\n${intro}\n\n*Order ID:* ${lastOrderDetails.id}\n*Date:* ${new Date().toLocaleDateString()}\n\n*Items:*\n${itemsList}\n\n*Total: $${lastOrderDetails.total.toFixed(2)}*\n\n_${footer}_`;
        
        window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function openAdminAuth() {
        const pin = prompt("Enter Admin PIN:");
        if (pin) {
            try { ADMIN_PIN = pin; await apiCall('VERIFY_ADMIN'); openAdminPanel(); } catch(e) { ADMIN_PIN = null; }
        }
    }
    
    function openAdminPanel() {
        router('admin');
        document.getElementById('adminEventName').innerText = appData.activeEventName;
        document.getElementById('editIntroRich').innerHTML = appData.config.intro || '';
        
        document.getElementById('editPayment').value = appData.config.paymentInfo || '';
        document.getElementById('editClosingDate').value = appData.config.closingDate || '';
        document.getElementById('editPin').value = appData.config.adminPin || '1234';
        
        loadEventList();
        renderAdminProducts();
        switchAdminTab('dashboard'); 
    }
    
    async function loadEventList() {
        const selector = document.getElementById('eventSelector');
        selector.innerHTML = '<option>Loading...</option>';
        try {
            const res = await apiCall('GET_EVENTS');
            selector.innerHTML = res.data.map(e => `
                <option value="${e.id}" ${e.id === appData.activeFolderId ? 'selected' : ''}>${e.name}</option>
            `).join('');
        } catch(e) {
            selector.innerHTML = '<option>Error loading events</option>';
        }
    }

    async function handleSwitchEvent() {
        const folderId = document.getElementById('eventSelector').value;
        if(!folderId || folderId.includes('Loading')) return;
        if(!confirm("Switch to this event? Products and Orders will change.")) return;
        
        await apiCall('SWITCH_EVENT', { folderId });
        alert("Event Switched! Reloading data...");
        loadAppData().then(() => {
             document.getElementById('adminEventName').innerText = appData.activeEventName;
             renderAdminProducts();
             document.getElementById('orderListContainer').innerHTML = '<p class="text-center text-gray-400 py-4">Reloading orders...</p>';
             document.getElementById('summaryTableBody').innerHTML = '';
        });
    }
    
    // ... (switchAdminTab, loadAdminOrders, calculateSummaries, renderConfigurableSummary, filterOrders, updateStatus, renderAdminProducts, openEventSheet, saveListing, resetOrder, saveSettings, uploadBanner, addProduct, deleteProduct, createNewEvent, adminLogout, router, showLoading, compressImage, openEventFolder unchanged) ...
    function switchAdminTab(tab) {
        ['dashboard', 'summary', 'fulfillment'].forEach(t => {
            const el = document.getElementById(`admin-panel-${t}`);
            const btn = document.getElementById(`tab-${t}`);
            if (t === tab) {
                el.classList.remove('hidden');
                btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            } else {
                el.classList.add('hidden');
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
        
        if (tab === 'fulfillment' || tab === 'summary') loadAdminOrders();
    }

    async function loadAdminOrders() {
        try {
            const res = await apiCall('GET_ORDERS');
            const grouped = {};
            res.data.forEach(item => {
                if (!grouped[item.orderId]) {
                    grouped[item.orderId] = { ...item, items: [] };
                }
                grouped[item.orderId].items.push({ name: item.item, qty: item.qty, price: (item.total/item.qty) }); 
                grouped[item.orderId].status = item.status; 
            });
            allOrders = Object.values(grouped).reverse();
            window.lastRawData = res.data; 

            if (!document.getElementById('admin-panel-fulfillment').classList.contains('hidden')) {
                filterOrders();
            }
            if (!document.getElementById('admin-panel-summary').classList.contains('hidden')) {
                calculateSummaries(res.data);
            }
            
        } catch(e) {
            console.error(e);
        }
    }

    function calculateSummaries(rawData) {
        const totalRev = rawData.reduce((acc, curr) => acc + curr.total, 0);
        const uniqueOrders = new Set(rawData.map(r => r.orderId)).size;
        
        const itemCounts = {};
        rawData.forEach(r => { itemCounts[r.item] = (itemCounts[r.item] || 0) + r.qty; });
        let topItem = "N/A"; let topCount = 0;
        Object.entries(itemCounts).forEach(([name, count]) => {
            if (count > topCount) { topCount = count; topItem = name; }
        });

        document.getElementById('sumRevenue').innerText = `$${totalRev.toFixed(2)}`;
        document.getElementById('sumOrders').innerText = uniqueOrders;
        document.getElementById('sumTopItem').innerText = topCount > 0 ? `${topItem} (${topCount} sold)` : "N/A";

        renderConfigurableSummary();
    }

    function renderConfigurableSummary() {
        const rows = window.lastRawData || [];
        const groupBy = document.getElementById('summaryGroupBy').value;
        const tbody = document.getElementById('summaryTableBody');
        tbody.innerHTML = '';

        const agg = {};

        rows.forEach(r => {
            let key = "Unknown";
            if (groupBy === 'item') {
                key = r.item;
            } else if (groupBy === 'userType') {
                const match = r.customer.match(/\[(.*?)(?:[:\]])/);
                key = match ? match[1] : "Other";
            }

            if (!agg[key]) agg[key] = { count: 0, total: 0 };
            agg[key].count += (groupBy === 'item' ? r.qty : 1);
            agg[key].total += r.total;
        });

        Object.entries(agg).forEach(([key, val]) => {
            tbody.innerHTML += `
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td class="px-4 py-2 font-medium text-gray-900 dark:text-white">${key}</td>
                    <td class="px-4 py-2">${val.count}</td>
                    <td class="px-4 py-2">$${val.total.toFixed(2)}</td>
                </tr>
            `;
        });
    }

    function filterOrders() {
        const search = document.getElementById('orderSearchInput').value.toLowerCase().replace(/\s/g, '');
        const container = document.getElementById('orderListContainer');
        
        const filtered = allOrders.filter(o => {
            const rawId = o.orderId.toLowerCase();
            const rawName = o.customer.toLowerCase().replace(/\s/g, '');
            const rawContact = String(o.contact).replace(/\D/g, '');
            return rawId.includes(search) || rawName.includes(search) || rawContact.includes(search);
        });

        if (filtered.length === 0) {
             container.innerHTML = '<p class="text-center text-gray-400 py-4">No orders found.</p>';
             return;
        }

        container.innerHTML = filtered.map(o => {
            const isCollected = o.status === "Collected";
            const itemsList = o.items.map(i => `<li><span class="font-bold">${i.qty}x</span> ${i.name}</li>`).join('');
            const actionBtn = isCollected 
                ? `<button onclick="updateStatus('${o.orderId}', 'Pending')" class="text-xs bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 shadow"><i class="fas fa-undo"></i> Undo</button>`
                : `<button onclick="updateStatus('${o.orderId}', 'Collected')" class="text-xs bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 shadow"><i class="fas fa-check"></i> Mark Collected</button>`;

            return `
            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 ${isCollected ? 'border-green-500' : 'border-yellow-500'}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-mono font-bold text-gray-700 dark:text-gray-200 text-lg">${o.orderId}</span>
                        <span class="ml-2 text-xs font-bold px-2 py-0.5 rounded uppercase tracking-wide ${isCollected ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300'}">${o.status}</span>
                    </div>
                    ${actionBtn}
                </div>
                <div class="font-bold text-gray-800 dark:text-gray-100">${o.customer}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-2"><i class="fas fa-phone-alt text-xs mr-1"></i> ${o.contact}</div>
                <ul class="list-disc pl-4 text-xs text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 p-2 rounded border border-gray-100 dark:border-gray-600">
                    ${itemsList}
                </ul>
            </div>`;
        }).join('');
    }

    async function updateStatus(id, newStatus) {
        const actionName = newStatus === 'Collected' ? 'Mark as Collected' : 'Undo (Mark as Pending)';
        if (!confirm(`${actionName} for ${id}?`)) return;
        try {
            const order = allOrders.find(o => o.orderId === id);
            if (order) order.status = newStatus;
            filterOrders();
            await apiCall('UPDATE_ORDER_STATUS', { orderId: id, status: newStatus });
        } catch(e) {
            alert("Error updating status");
            loadAdminOrders();
        }
    }

    function renderAdminProducts() {
        const list = document.getElementById('adminProductList');
        if (appData.products.length === 0) list.innerHTML = "<p class='text-gray-500 text-sm'>No products added.</p>";
        else {
            list.innerHTML = appData.products.map((p) => `
            <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded border dark:border-gray-600 text-sm" data-id="${p.id}">
                <div class="handle cursor-move px-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                     <i class="fas fa-grip-lines"></i>
                </div>
                <div class="flex-1 px-3"><div class="font-bold text-gray-700 dark:text-white">${p.name}</div><div class="text-xs text-gray-500 dark:text-gray-400">$${p.price}</div></div>
                <button onclick="deleteProduct('${p.id}')" class="text-red-500 font-bold px-2">X</button>
            </div>`).join('');
            
            if(typeof Sortable !== 'undefined') {
                if(sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(list, {
                    handle: '.handle',
                    animation: 150,
                    ghostClass: 'bg-blue-100'
                });
            }
        }
    }

    function openEventSheet() {
        if (appData.activeSheetId) window.open(`https://docs.google.com/spreadsheets/d/${appData.activeSheetId}`, '_blank');
        else alert("No active sheet available.");
    }

    async function saveListing() {
        if (!confirm("Save this display order?")) return;
        const domItems = document.querySelectorAll('#adminProductList > div');
        const idList = Array.from(domItems).map(el => el.getAttribute('data-id'));
        await apiCall('SAVE_ORDER', idList);
        alert("Listing Saved!");
    }
    
    async function resetOrder() {
        if (!confirm("Reset to default Alphabetical order?")) return;
        await apiCall('RESET_ORDER');
        loadAppData().then(openAdminPanel);
    }
    async function saveSettings() {
        const paynowVal = document.getElementById('editPayment').value;
        if (!/^\d{8}$/.test(paynowVal)) { alert("PayNow Number must be exactly 8 digits."); return; }
        await apiCall('UPDATE_CONFIG', { 
            intro: document.getElementById('editIntroRich').innerHTML, 
            appTitle: document.getElementById('editAppTitle').value,
            
            paymentInfo: paynowVal, 
            closingDate: document.getElementById('editClosingDate').value,
            adminPin: document.getElementById('editPin').value,
            emailIntro: document.getElementById('editEmailIntro').value,
            emailFooter: document.getElementById('editEmailFooter').value,
            bannerImageId: appData.config.bannerImageId 
        });
        alert("Saved!"); loadAppData();
    }
    async function addProduct() {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const file = document.getElementById('newProdImg').files[0];
        if (!name || !price || !file) return alert("All fields required");
        showLoading(true, "Compressing & Uploading...");
        const base64 = await compressImage(file, 0.5); 
        await apiCall('ADD_PRODUCT', { name, price, imageBase64: base64, mimeType: 'image/jpeg' });
        document.getElementById('newProdName').value = ''; document.getElementById('newProdPrice').value = ''; document.getElementById('newProdImg').value = '';
        alert("Product Added!"); loadAppData().then(openAdminPanel);
    }
    async function deleteProduct(id) {
        if(confirm("Delete product?")) { await apiCall('DELETE_PRODUCT', id); loadAppData().then(openAdminPanel); }
    }
    async function createNewEvent() {
        const name = document.getElementById('newEventName').value;
        if (name && confirm("Create new event?")) { await apiCall('CREATE_EVENT', name); alert("Event Created!"); loadAppData().then(openAdminPanel); }
    }
    function adminLogout() { ADMIN_PIN = null; router('home'); }
    function router(view) {
        document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        window.scrollTo(0,0);
        if (view === 'checkout') generatePayNowQR();
    }
    function showLoading(show, text="Processing...") {
        const el = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').innerText = text;
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
    }
    function compressImage(file, quality=0.5) {
        return new Promise((resolve, reject) => {
            const MAX_WIDTH = 1000;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality)); 
                };
            };
            reader.onerror = reject;
        });
    }
    
    // NEW: Open Folder function that was missing in previous steps
    function openEventFolder() {
        if (appData.activeFolderId) window.open(`https://drive.google.com/drive/folders/${appData.activeFolderId}`, '_blank');
        else alert("No active folder available.");
    }
</script>
</body>
</html>
